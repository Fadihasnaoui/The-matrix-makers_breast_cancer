<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breast Cancer Detection - Complete Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .master-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .model-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .model-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .model-card.active {
            border: 3px solid var(--primary);
            background: #f8f9ff;
        }

        .tab-content {
            background: white;
            padding: 25px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .nav-tabs {
            border-bottom: 3px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 10px 10px 0 0;
            background: #f8f9fa;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: white;
            border-bottom: 3px solid var(--primary);
        }

        .feature-input {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .prediction-result {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .confidence-bar {
            height: 25px;
            border-radius: 12px;
            background: #e9ecef;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 12px;
        }

        .pca-plot {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-healthy {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-danger {
            background-color: #dc3545;
        }

        .shap-impact-positive {
            background: linear-gradient(90deg, #ffe5e5, #ffcccc);
            border-left: 4px solid var(--danger);
        }

        .shap-impact-negative {
            background: linear-gradient(90deg, #e5ffe5, #ccffcc);
            border-left: 4px solid var(--success);
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="master-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-heart-pulse"></i> Breast Cancer Detection System</h1>
                    <p class="mb-0">Complete ML Pipeline with Model Selection & PCA Analysis</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="bg-white text-dark rounded p-3">
                        <span class="status-indicator status-healthy"></span>
                        <strong>System:</strong> <span id="systemStatus">Healthy</span>
                        <br>
                        <small id="modelStatus">Loading models...</small>
                        <br>
                        <a href="/analysis" class="btn btn-info btn-sm mt-2">
                            <i class="bi bi-bar-chart-line"></i> Advanced Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#prediction">
                    <i class="bi bi-sliders"></i> Prediction
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#models">
                    <i class="bi bi-cpu"></i> Model Selection
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#pca">
                    <i class="bi bi-graph-up"></i> PCA Analysis
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#monitoring">
                    <i class="bi bi-speedometer2"></i> Monitoring
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Prediction Tab -->
            <div class="tab-pane fade show active" id="prediction">
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-md-4">
                        <!-- Current Model -->
                        <div class="card model-card active">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Active Model</h5>
                            </div>
                            <div class="card-body">
                                <h4 id="currentModelName">Loading...</h4>
                                <div class="row text-center mb-3">
                                    <div class="col-6">
                                        <div class="display-6 text-success" id="currentModelAccuracy">-</div>
                                        <small class="text-muted">Accuracy</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="display-6 text-info" id="currentModelRecall">-</div>
                                        <small class="text-muted">Recall</small>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary w-100" onclick="refreshModels()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Models
                                </button>
                            </div>
                        </div>

                        <!-- Prediction Result -->
                        <div class="card mt-3 prediction-result" id="predictionResult" style="display: none;">
                            <div class="card-body">
                                <h4><i class="bi bi-clipboard-check"></i> Prediction Result</h4>
                                <div id="resultContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-8">
                        <!-- Feature Input -->
                        <div class="card">
                            <div class="card-body">
                                <h4><i class="bi bi-sliders"></i> Feature Input</h4>
                                <p>Enter values for all 30 features or use sample data:</p>

                                <div class="mb-3">
                                    <button class="btn btn-success btn-sm" onclick="loadSampleData()">
                                        <i class="bi bi-download"></i> Load Sample
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="resetForm()">
                                        <i class="bi bi-x-circle"></i> Reset
                                    </button>
                                    <button class="btn btn-info btn-sm float-end" onclick="toggleFeatureView()">
                                        <i class="bi bi-layout-split"></i> Toggle View
                                    </button>
                                </div>

                                <div id="featureInputs">
                                    <!-- Features will be loaded here -->
                                </div>

                                <div class="mt-4">
                                    <button class="btn btn-primary btn-lg w-100" onclick="makePrediction()">
                                        <i class="bi bi-heart-pulse"></i> Make Prediction
                                    </button>
                                    <button class="btn btn-info w-100 mt-2" onclick="generateSHAPExplanation()" id="shapButton">
                                        <i class="bi bi-magic"></i> Explain Prediction with SHAP
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Model Select -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5><i class="bi bi-lightning"></i> Quick Model Select</h5>
                                <div class="row" id="quickModelSelect">
                                    <!-- Quick buttons will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- SHAP Results -->
                        <div class="card mt-3" id="shapResultCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> SHAP Explanation</h5>
                            </div>
                            <div class="card-body">
                                <div id="shapResultContent">
                                    <!-- SHAP results will load here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Selection Tab -->
            <div class="tab-pane fade" id="models">
                <h3><i class="bi bi-cpu"></i> Model Selection</h3>
                <p>Click any model to activate it for predictions:</p>

                <div class="row" id="modelsGrid">
                    <!-- Models will be loaded here -->
                </div>

                <div class="mt-4">
                    <button class="btn btn-primary" onclick="retrainModels()">
                        <i class="bi bi-arrow-repeat"></i> Retrain All Models
                    </button>
                    <button class="btn btn-success" onclick="refreshModels()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh List
                    </button>
                </div>
            </div>

            <!-- PCA Analysis Tab -->
            <div class="tab-pane fade" id="pca">
                <h3><i class="bi bi-graph-up"></i> PCA Analysis</h3>
                <p>Principal Component Analysis visualization of the dataset:</p>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h5>PCA Visualization</h5>
                                <img id="pcaPlot" class="pca-plot" style="display: none;">
                                <div id="pcaLoading" class="text-center">
                                    <div class="spinner-border text-primary"></div>
                                    <p>Loading PCA visualization...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5>PCA Information</h5>
                                <div id="pcaInfo">
                                    <p><strong>Variance Explained:</strong></p>
                                    <ul>
                                        <li>PC1: <span id="pc1Var">-</span>%</li>
                                        <li>PC2: <span id="pc2Var">-</span>%</li>
                                        <li>Total: <span id="totalVar">-</span>%</li>
                                    </ul>
                                    <p><strong>Interpretation:</strong></p>
                                    <p>PCA reduces 30 features to 2 dimensions while preserving maximum variance. Points closer together are more similar.</p>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-body">
                                <h5>Last Prediction PCA</h5>
                                <div id="lastPredictionPCA">
                                    <p class="text-muted">Make a prediction to see PCA coordinates</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div class="tab-pane fade" id="monitoring">
                <h3><i class="bi bi-speedometer2"></i> System Monitoring</h3>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="bi bi-activity"></i> System Health</h5>
                                <div id="healthStatus">
                                    <p><i class="bi bi-circle-fill text-success"></i> API: <strong>Healthy</strong></p>
                                    <p><i class="bi bi-circle-fill text-success"></i> Models: <strong>Loaded</strong></p>
                                </div>
                                <button class="btn btn-primary" onclick="checkHealth()">
                                    <i class="bi bi-arrow-repeat"></i> Refresh Health
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5><i class="bi bi-link-45deg"></i> Quick Links</h5>
                                <div class="list-group">
                                    <a href="http://localhost:9090" target="_blank" class="list-group-item list-group-item-action">
                                        <i class="bi bi-graph-up"></i> Prometheus UI
                                    </a>
                                    <a href="/metrics" target="_blank" class="list-group-item list-group-item-action">
                                        <i class="bi bi-speedometer"></i> Metrics Endpoint
                                    </a>
                                    <a href="/docs" target="_blank" class="list-group-item list-group-item-action">
                                        <i class="bi bi-code-slash"></i> API Documentation
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h5><i class="bi bi-bar-chart"></i> System Metrics</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="display-6" id="totalPredictions">0</div>
                                    <small class="text-muted">Total Predictions</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="display-6" id="uptime">0</div>
                                    <small class="text-muted">Uptime (min)</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="display-6" id="totalModels">0</div>
                                    <small class="text-muted">Models</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="display-6" id="featuresCount">0</div>
                                    <small class="text-muted">Features</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentModel = null;
        let allModels = {};
        let featureNames = [];
        let sampleValues = [];
        let compactView = false;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            loadAllModels();
            loadPCA();
            startHealthMonitoring();
        });

        async function loadInitialData() {
            try {
                const response = await fetch('/features');
                const data = await response.json();
                featureNames = data.features;
                sampleValues = data.sample_values || Array(30).fill(0);
                generateFeatureInputs();
            } catch (error) {
                console.error('Error loading features:', error);
            }
        }

        function generateFeatureInputs() {
            const container = document.getElementById('featureInputs');
            container.innerHTML = '';

            if (compactView) {
                // Compact view: 6 columns
                container.className = 'row';
                for (let i = 0; i < 30; i += 6) {
                    const row = document.createElement('div');
                    row.className = 'row mb-2';

                    for (let j = 0; j < 6 && (i + j) < 30; j++) {
                        const idx = i + j;
                        const featureName = featureNames[idx] || `F${idx + 1}`;
                        const col = document.createElement('div');
                        col.className = 'col-2';
                        col.innerHTML = `
                            <label class="form-label small">${featureName}</label>
                            <input type="number" class="form-control form-control-sm"
                                   id="feature_${idx}" step="0.001" placeholder="0">
                        `;
                        row.appendChild(col);
                    }
                    container.appendChild(row);
                }
            } else {
                // Detailed view: 2 columns
                container.className = 'row';
                for (let i = 0; i < 30; i++) {
                    const featureName = featureNames[i] || `Feature ${i + 1}`;
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <div class="feature-input">
                            <label class="form-label">${featureName}</label>
                            <div class="input-group">
                                <input type="number" class="form-control"
                                       id="feature_${i}" step="0.001" placeholder="Enter value">
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="setFeatureValue(${i}, ${sampleValues[i] || 0})">
                                    Sample
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            }
        }

        function toggleFeatureView() {
            compactView = !compactView;
            generateFeatureInputs();
        }

        async function loadAllModels() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                allModels = data.available_models;

                // Update model count
                document.getElementById('modelStatus').textContent =
                    `${Object.keys(allModels).length} models available`;

                // Update current model
                if (data.current_model && data.current_model !== 'None') {
                    currentModel = allModels[data.current_model];
                    updateCurrentModelDisplay();
                    generateModelsGrid();
                    generateQuickSelect();
                }

            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        function updateCurrentModelDisplay() {
            if (currentModel) {
                document.getElementById('currentModelName').textContent = currentModel.name;
                document.getElementById('currentModelAccuracy').textContent =
                    (currentModel.accuracy * 100).toFixed(1) + '%';
                document.getElementById('currentModelRecall').textContent =
                    (currentModel.recall * 100).toFixed(1) + '%';
            }
        }

        function generateModelsGrid() {
            const container = document.getElementById('modelsGrid');
            container.innerHTML = '';

            Object.entries(allModels).forEach(([id, model]) => {
                const isActive = currentModel && currentModel.id === id;
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
                    <div class="card model-card ${isActive ? 'active' : ''}"
                         onclick="switchModel('${id}')">
                        <div class="card-header ${isActive ? 'bg-primary' : 'bg-secondary'} text-white">
                            <h6 class="mb-0">${model.name}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="display-6 text-success">
                                        ${(model.accuracy * 100).toFixed(1)}%
                                    </div>
                                    <small class="text-muted">Accuracy</small>
                                </div>
                                <div class="col-6">
                                    <div class="display-6 text-info">
                                        ${(model.recall * 100).toFixed(1)}%
                                    </div>
                                    <small class="text-muted">Recall</small>
                                </div>
                            </div>
                            ${isActive ? '<div class="text-center mt-2"><span class="badge bg-primary">Active</span></div>' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function generateQuickSelect() {
            const container = document.getElementById('quickModelSelect');
            container.innerHTML = '';

            Object.entries(allModels).forEach(([id, model]) => {
                const isActive = currentModel && currentModel.id === id;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `btn ${isActive ? 'btn-primary' : 'btn-outline-primary'} col-4 mb-2`;
                btn.style.margin = '2px';
                btn.textContent = model.name.split(' ')[0];
                btn.title = model.name;
                btn.onclick = () => switchModel(id);
                container.appendChild(btn);
            });
        }

        async function switchModel(modelId) {
            try {
                const response = await fetch('/switch-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: modelId })
                });

                const data = await response.json();
                if (data.success) {
                    currentModel = allModels[modelId];
                    updateCurrentModelDisplay();
                    generateModelsGrid();
                    generateQuickSelect();
                    alert(`✅ Switched to ${currentModel.name}`);
                }
            } catch (error) {
                console.error('Error switching model:', error);
                alert('Error switching model');
            }
        }

        async function makePrediction() {
            // Collect feature values
            const features = [];
            for (let i = 0; i < 30; i++) {
                const input = document.getElementById(`feature_${i}`);
                const value = parseFloat(input.value);
                if (isNaN(value)) {
                    alert(`Please enter a valid number for feature ${i + 1}`);
                    input.focus();
                    return;
                }
                features.push(value);
            }

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        features: features,
                        model_id: currentModel ? currentModel.id : 'mlp'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    displayPredictionResult(data);
                    // Show SHAP button after prediction
                    document.getElementById('shapButton').style.display = 'block';
                }
            } catch (error) {
                console.error('Error making prediction:', error);
                alert('Prediction failed: ' + error.message);
            }
        }

        function displayPredictionResult(data) {
            const resultDiv = document.getElementById('predictionResult');
            const contentDiv = document.getElementById('resultContent');

            const prediction = data.prediction;
            const isMalignant = prediction.class === 'MALIGNANT';
            const confidence = prediction.confidence * 100;
            const benignProb = prediction.probabilities.benign * 100;
            const malignantProb = prediction.probabilities.malignant * 100;

            contentDiv.innerHTML = `
                <div class="alert ${isMalignant ? 'alert-danger' : 'alert-success'}">
                    <h4 class="alert-heading">
                        <i class="bi bi-${isMalignant ? 'exclamation-triangle' : 'check-circle'}"></i>
                        ${prediction.class}
                    </h4>
                    <p>Confidence: <strong>${confidence.toFixed(1)}%</strong></p>
                </div>

                <h5>Probability Distribution</h5>
                <div class="confidence-bar">
                    <div class="confidence-fill ${isMalignant ? 'bg-danger' : 'bg-success'}"
                         style="width: ${confidence}%"></div>
                </div>

                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="p-2 bg-success text-white rounded">
                            <h5>${benignProb.toFixed(1)}%</h5>
                            <small>Benign</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 bg-danger text-white rounded">
                            <h5>${malignantProb.toFixed(1)}%</h5>
                            <small>Malignant</small>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <p><strong>Model used:</strong> ${data.model_used.name}</p>
                    <p><strong>Accuracy:</strong> ${(data.model_used.accuracy * 100).toFixed(1)}%</p>
                </div>
            `;

            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });

            // Update PCA coordinates if available
            if (data.pca_coordinates) {
                const pcaDiv = document.getElementById('lastPredictionPCA');
                pcaDiv.innerHTML = `
                    <p><strong>PCA Coordinates:</strong></p>
                    <p>PC1: ${data.pca_coordinates.pc1.toFixed(4)}</p>
                    <p>PC2: ${data.pca_coordinates.pc2.toFixed(4)}</p>
                    <p class="small text-muted">This prediction is located at these coordinates in the PCA plot</p>
                `;
            }
        }

        function loadSampleData() {
            for (let i = 0; i < 30; i++) {
                const input = document.getElementById(`feature_${i}`);
                if (input && sampleValues[i] !== undefined) {
                    input.value = sampleValues[i].toFixed(6);
                }
            }
            alert('Sample data loaded');
        }

        function setFeatureValue(index, value) {
            const input = document.getElementById(`feature_${index}`);
            if (input) {
                input.value = value.toFixed(6);
                input.focus();
            }
        }

        function resetForm() {
            for (let i = 0; i < 30; i++) {
                const input = document.getElementById(`feature_${i}`);
                if (input) {
                    input.value = '';
                }
            }
            document.getElementById('predictionResult').style.display = 'none';
            document.getElementById('shapResultCard').style.display = 'none';
        }

        async function retrainModels() {
            if (confirm('Are you sure you want to retrain all models? This may take a few moments.')) {
                try {
                    const response = await fetch('/retrain', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        alert('✅ Models retrained successfully!');
                        loadAllModels();
                        loadPCA();
                    } else {
                        alert('Failed to retrain models');
                    }
                } catch (error) {
                    console.error('Error retraining models:', error);
                    alert('Error retraining models');
                }
            }
        }

        async function loadPCA() {
            try {
                const response = await fetch('/pca/plot');
                const data = await response.json();

                // Display PCA plot
                const pcaPlot = document.getElementById('pcaPlot');
                pcaPlot.src = `data:image/png;base64,${data.plot}`;
                pcaPlot.style.display = 'block';
                document.getElementById('pcaLoading').style.display = 'none';

                // Update variance info
                document.getElementById('pc1Var').textContent = data.variance_explained.pc1.toFixed(1);
                document.getElementById('pc2Var').textContent = data.variance_explained.pc2.toFixed(1);
                document.getElementById('totalVar').textContent = data.variance_explained.total.toFixed(1);

            } catch (error) {
                console.error('Error loading PCA:', error);
                document.getElementById('pcaLoading').innerHTML =
                    '<div class="alert alert-warning">PCA visualization not available</div>';
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                updateHealthDisplay(data);
            } catch (error) {
                console.error('Error checking health:', error);
            }
        }

        function updateHealthDisplay(data) {
            const healthDiv = document.getElementById('healthStatus');
            healthDiv.innerHTML = `
                <p><i class="bi bi-circle-fill text-${data.status === 'healthy' ? 'success' : 'danger'}"></i>
                   API: <strong>${data.status}</strong></p>
                <p><i class="bi bi-circle-fill ${data.model_loaded ? 'text-success' : 'text-danger'}"></i>
                   Models: <strong>${data.model_loaded ? 'Loaded' : 'Not Loaded'}</strong></p>
                <p><i class="bi bi-circle-fill text-success"></i>
                   Active Model: <strong>${data.active_model}</strong></p>
                <p><i class="bi bi-circle-fill text-success"></i>
                   Accuracy: <strong>${(data.model_accuracy * 100).toFixed(1)}%</strong></p>
            `;

            // Update metrics
            document.getElementById('totalPredictions').textContent = data.predictions_made;
            document.getElementById('uptime').textContent = Math.floor(data.uptime_seconds / 60);
            document.getElementById('totalModels').textContent = data.total_models;
            document.getElementById('featuresCount').textContent = data.features_count;
        }

        function refreshModels() {
            loadAllModels();
            alert('Models refreshed');
        }

        function startHealthMonitoring() {
            // Check health every 30 seconds
            checkHealth();
            setInterval(checkHealth, 30000);
        }

        // ============ SHAP EXPLANATION FUNCTIONS ============

        async function generateSHAPExplanation() {
            // First check if we have features entered
            let allFeaturesEntered = true;
            for (let i = 0; i < 30; i++) {
                const input = document.getElementById(`feature_${i}`);
                if (!input.value) {
                    allFeaturesEntered = false;
                    break;
                }
            }
            
            if (!allFeaturesEntered) {
                alert('Please enter all feature values or load sample data before generating SHAP explanation.');
                return;
            }
            
            // Collect feature values
            const features = [];
            for (let i = 0; i < 30; i++) {
                const input = document.getElementById(`feature_${i}`);
                const value = parseFloat(input.value);
                if (isNaN(value)) {
                    alert(`Please enter a valid number for feature ${i + 1}`);
                    input.focus();
                    return;
                }
                features.push(value);
            }
            
            try {
                // Show loading state
                const resultDiv = document.getElementById('shapResultContent');
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-info"></div>
                        <p class="mt-2">Generating SHAP explanation...</p>
                    </div>
                `;
                
                // Show the SHAP card
                document.getElementById('shapResultCard').style.display = 'block';
                
                // Get current model ID
                const currentModelId = currentModel ? currentModel.id : 'mlp';
                
                // Call SHAP API
                const response = await fetch('/shap/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        features: features,
                        model_id: currentModelId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySHAPResults(data);
                } else if (data.available === false) {
                    // SHAP not installed - show simulation
                    displaySHAPSimulation(features, data.message);
                } else {
                    alert('Error: ' + (data.error || data.message));
                }
                
            } catch (error) {
                console.error('SHAP Error:', error);
                displaySHAPSimulation(features, error.message);
            }
        }

        function displaySHAPResults(data) {
            const container = document.getElementById('shapResultContent');
            
            let html = '';
            
            // Display force plot if available
            if (data.plot && data.plot.data) {
                html += `
                    <h6>Force Plot Visualization</h6>
                    <img src="data:image/png;base64,${data.plot.data}" class="img-fluid mb-3 rounded" alt="SHAP Force Plot">
                    <div class="alert alert-light small mb-3">
                        <strong>Interpretation:</strong> Features pushing to the right (red) increase cancer risk, 
                        features pushing left (blue) decrease risk.
                    </div>
                `;
            }
            
            // Display top features
            html += `
                <h6>Top Contributing Features</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Value</th>
                                <th>Impact</th>
                                <th>Contribution</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            (data.top_features || []).forEach(feature => {
                const rowClass = feature.impact > 0 ? 'table-danger' : 'table-success';
                const impactIcon = feature.impact > 0 ? '↑' : '↓';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${feature.name}</strong></td>
                        <td>${feature.value.toFixed(4)}</td>
                        <td>${impactIcon} ${feature.direction}</td>
                        <td>${feature.impact > 0 ? '+' : ''}${feature.impact.toFixed(4)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Explanation</h6>
                    <p><strong>Base Value:</strong> ${data.base_value ? data.base_value.toFixed(4) : 'N/A'} (average prediction)</p>
                    <p><strong>Features in red</strong> increase cancer risk.</p>
                    <p><strong>Features in green</strong> decrease cancer risk.</p>
                    ${data.prediction_value ? `<p><strong>Final Prediction Value:</strong> ${data.prediction_value.toFixed(4)}</p>` : ''}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displaySHAPSimulation(features, errorMessage) {
            const container = document.getElementById('shapResultContent');
            
            // Create simulated SHAP values based on feature values
            // Higher values for certain features = more likely malignant
            const featureImportanceMap = {
                'radius_worst': 0.85, 'concave_points_worst': 0.72, 'perimeter_worst': 0.68,
                'area_worst': 0.64, 'concavity_mean': 0.58, 'texture_worst': 0.42,
                'smoothness_worst': 0.38, 'compactness_worst': 0.35
            };
            
            const mockFeatures = features.map((value, idx) => {
                const featureName = featureNames[idx] || `Feature ${idx + 1}`;
                const baseImportance = featureImportanceMap[featureName] || 0.2;
                
                // Simulate impact: higher value + importance = higher impact
                const impact = (value - 10) * baseImportance * 0.05 + (Math.random() - 0.5) * 0.1;
                
                return {
                    name: featureName,
                    value: value,
                    impact: impact,
                    direction: impact > 0 ? 'increases risk' : 'decreases risk',
                    importance: Math.abs(impact)
                };
            }).sort((a, b) => b.importance - a.importance).slice(0, 10);
            
            let html = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>SHAP Analysis Simulation</strong>
                    <p class="mb-0">${errorMessage || 'SHAP package not installed. This is a simulation of what real SHAP would show.'}</p>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="bi bi-download"></i> To enable real SHAP:</h6>
                    <code>pip install shap</code>
                    <p class="mt-2 small">Then restart your server for actual mathematical feature importance analysis.</p>
                </div>
                
                <h6>Simulated Feature Impact</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Value</th>
                                <th>Impact</th>
                                <th>Direction</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            mockFeatures.forEach(feature => {
                const rowClass = feature.impact > 0 ? 'table-danger' : 'table-success';
                const impactIcon = feature.impact > 0 ? '↑' : '↓';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${feature.name}</strong></td>
                        <td>${feature.value.toFixed(4)}</td>
                        <td>${feature.impact > 0 ? '+' : ''}${feature.impact.toFixed(4)}</td>
                        <td>${impactIcon} ${feature.direction}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-light mt-3">
                    <h6><i class="bi bi-info-circle"></i> How real SHAP works:</h6>
                    <p class="small mb-0">Real SHAP uses game theory to mathematically calculate how much each feature contributes to the prediction. It provides consistent and fair feature attributions.</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>
